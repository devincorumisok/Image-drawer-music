<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Virtualizer — GitHub Pages MP3-Safe</title>
<style>
  :root{--accent:#111;--muted:#666;--bg:#ffffff}
  html,body{height:100%;margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--accent)}
  .app{display:grid;grid-template-columns:320px 1fr;height:100vh}
  .sidebar{border-right:1px solid #eee;padding:16px;background:#fafafa;overflow:auto}
  h1{font-size:18px;margin:0 0 12px}
  label{display:block;font-size:12px;color:var(--muted);margin-top:12px}
  input[type=range],select,input[type=color],input[type=text]{width:100%}
  .btn{padding:6px 10px;margin-top:8px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer}
  .canvas-wrap{position:relative;background:var(--bg)}
  canvas{display:block;width:100%;height:100%}
  .dropzone{margin-top:8px;border:2px dashed #ddd;padding:10px;text-align:center;color:#666;font-size:13px;border-radius:8px}
  .meta{font-size:13px;color:#666;margin-top:8px}
  .row{display:flex;gap:6px;align-items:center}
  .footer{position:absolute;left:16px;bottom:16px;font-size:12px;color:#aaa}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h1>Music Virtualizer</h1>

    <label>Load audio file</label>
    <input id="file" type="file" accept="audio/*,.mp3,.wav,.ogg,.m4a" />
    <div class="dropzone" id="drop">Or drag & drop audio file here</div>

    <label>Visualization</label>
    <select id="visType">
      <option value="bars">Bars</option>
      <option value="wave">Waveform</option>
      <option value="radial">Radial</option>
      <option value="particles">Particles</option>
    </select>

    <label>FFT size</label>
    <select id="fftSize">
      <option>128</option>
      <option selected>256</option>
      <option>512</option>
      <option>1024</option>
    </select>

    <label>Bar count</label>
    <input id="barCount" type="range" min="8" max="256" value="64" />

    <label>Sensitivity</label>
    <input id="sensitivity" type="range" min="0.2" max="5" step="0.1" value="1" />

    <label>Smoothing</label>
    <input id="smoothing" type="range" min="0" max="0.99" step="0.01" value="0.6" />

    <label>Color</label>
    <input id="color" type="color" value="#111111" />

    <label>Background</label>
    <input id="bgColor" type="color" value="#ffffff" />

    <label><input id="glow" type="checkbox"> Glow</label>
    <label><input id="invert" type="checkbox"> Invert Colors</label>

    <button id="downloadPNG" class="btn">Download Snapshot</button>
    <div class="meta" id="trackInfo">No track loaded</div>
  </div>

  <div class="canvas-wrap">
    <canvas id="c"></canvas>
    <div class="footer">Visualizer — GitHub Pages MP3-safe</div>
  </div>
</div>

<script>
let audioCtx, analyser, dataArray, bufferLength, sourceNode;
let playing=false, rafId=null;

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");

const fileInput=document.getElementById("file");
const drop=document.getElementById("drop");
const trackInfo=document.getElementById("trackInfo");
const visType=document.getElementById("visType");
const fftSelect=document.getElementById("fftSize");
const barCountSlider=document.getElementById("barCount");
const sensitivitySlider=document.getElementById("sensitivity");
const smoothingSlider=document.getElementById("smoothing");
const colorInput=document.getElementById("color");
const bgColorInput=document.getElementById("bgColor");
const glowCheckbox=document.getElementById("glow");
const invertCheckbox=document.getElementById("invert");
const downloadPNG=document.getElementById("downloadPNG");

function ensureCtx(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  }
}
function resizeCanvas(){
  canvas.width=canvas.clientWidth*devicePixelRatio;
  canvas.height=canvas.clientHeight*devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize",resizeCanvas);resizeCanvas();

fileInput.addEventListener("change",e=>{
  if(e.target.files[0]) handleFile(e.target.files[0]);
});
drop.addEventListener("dragover",e=>{e.preventDefault();drop.style.borderColor="#aaa"});
drop.addEventListener("dragleave",()=>drop.style.borderColor="#ddd");
drop.addEventListener("drop",e=>{
  e.preventDefault();drop.style.borderColor="#ddd";
  if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

async function handleFile(file){
  ensureCtx();
  if(sourceNode){try{sourceNode.stop()}catch(e){};sourceNode.disconnect();}
  const arrayBuffer=await file.arrayBuffer();
  const audioBuffer=await audioCtx.decodeAudioData(arrayBuffer);

  analyser=audioCtx.createAnalyser();
  analyser.fftSize=parseInt(fftSelect.value);
  analyser.smoothingTimeConstant=parseFloat(smoothingSlider.value);
  bufferLength=analyser.frequencyBinCount;
  dataArray=new Uint8Array(bufferLength);

  sourceNode=audioCtx.createBufferSource();
  sourceNode.buffer=audioBuffer;
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);
  sourceNode.onended=()=>playing=false;
  sourceNode.start();
  playing=true;
  trackInfo.textContent="Loaded: "+file.name;
  render();
}

function render(){
  rafId=requestAnimationFrame(render);
  if(!analyser) return;
  analyser.smoothingTimeConstant=parseFloat(smoothingSlider.value);
  if(analyser.fftSize!==parseInt(fftSelect.value)){
    analyser.fftSize=parseInt(fftSelect.value);
    bufferLength=analyser.frequencyBinCount;
    dataArray=new Uint8Array(bufferLength);
  }
  const vis=visType.value;
  const w=canvas.width/devicePixelRatio,h=canvas.height/devicePixelRatio;
  ctx.fillStyle=bgColorInput.value;
  ctx.fillRect(0,0,w,h);

  if(vis==="wave"){analyser.getByteTimeDomainData(dataArray);}
  else{analyser.getByteFrequencyData(dataArray);}

  const sens=parseFloat(sensitivitySlider.value);
  const color=colorInput.value;
  const glow=glowCheckbox.checked;
  const invert=invertCheckbox.checked;

  if(invert){
    ctx.save();ctx.globalCompositeOperation="difference";
    ctx.fillStyle="#fff";ctx.fillRect(0,0,w,h);ctx.restore();
  }

  if(vis==="bars"){
    const count=parseInt(barCountSlider.value);
    const binStep=Math.floor(dataArray.length/count);
    const bw=w/count;
    for(let i=0;i<count;i++){
      let sum=0;for(let j=0;j<binStep;j++) sum+=dataArray[i*binStep+j]||0;
      const v=(sum/binStep)/255*sens;
      const barH=h*v;
      if(glow){ctx.shadowBlur=12;ctx.shadowColor=color;}
      ctx.fillStyle=color;
      ctx.fillRect(i*bw,h-barH,bw*0.8,barH);
    }
    ctx.shadowBlur=0;
  }
  else if(vis==="wave"){
    ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=2;
    for(let i=0;i<dataArray.length;i++){
      const v=dataArray[i]/128.0;
      const y=(v*h/2)*sens;
      const x=i*(w/bufferLength);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    if(glow){ctx.shadowBlur=12;ctx.shadowColor=color;}
    ctx.stroke();ctx.shadowBlur=0;
  }
  else if(vis==="radial"){
    const cx=w/2,cy=h/2,r=Math.min(w,h)*0.18;
    const count=parseInt(barCountSlider.value);
    const step=Math.floor(dataArray.length/count);
    for(let i=0;i<count;i++){
      let sum=0;for(let j=0;j<step;j++) sum+=dataArray[i*step+j]||0;
      const v=(sum/step)/255*sens;
      const len=r+v*r*2;
      const angle=i/count*Math.PI*2;
      ctx.beginPath();
      ctx.strokeStyle=color;ctx.lineWidth=2;
      if(glow){ctx.shadowBlur=12;ctx.shadowColor=color;}
      ctx.moveTo(cx+Math.cos(angle)*r,cy+Math.sin(angle)*r);
      ctx.lineTo(cx+Math.cos(angle)*len,cy+Math.sin(angle)*len);
      ctx.stroke();ctx.shadowBlur=0;
    }
  }
  else if(vis==="particles"){
    const count=Math.min(200,parseInt(barCountSlider.value)*2);
    const now=Date.now()*0.001;
    for(let i=0;i<count;i++){
      const t=i/count,angle=t*Math.PI*2+now*0.5;
      const radius=Math.min(w,h)*0.4*(0.3+Math.abs(Math.sin(t*5+now*0.5)));
      const x=w/2+Math.cos(angle)*radius;
      const y=h/2+Math.sin(angle)*radius;
      const v=(dataArray[Math.floor(t*dataArray.length)]||0)/255*sens;
      const size=2+v*6;
      ctx.beginPath();
      ctx.fillStyle=color;
      if(glow){ctx.shadowBlur=12;ctx.shadowColor=color;}
      ctx.arc(x,y,size,0,Math.PI*2);
      ctx.fill();ctx.shadowBlur=0;
    }
  }
}

downloadPNG.addEventListener("click",()=>{
  const link=document.createElement("a");
  link.href=canvas.toDataURL("image/png");
  link.download="visualizer.png";
  link.click();
});
</script>
</body>
</html>
