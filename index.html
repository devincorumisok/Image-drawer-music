<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Photo → Drawing (Audio Reactive)</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111}
  body{display:flex;flex-direction:column;gap:10px;align-items:center;padding:18px;background:#f6f7fb}
  h1{margin:0;font-size:18px}
  #controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .panel{background:white;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(20,30,50,.08)}
  canvas{background:white;border-radius:8px;max-width:100%;height:auto;box-shadow:0 6px 18px rgba(20,30,50,.06)}
  label{display:block;font-size:13px;margin-bottom:6px}
  input[type="range"]{width:200px}
  .row{display:flex;gap:8px;align-items:center}
  button{padding:8px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
  .small{font-size:13px}
  footer{font-size:12px;color:#666;margin-top:8px}
  .col{display:flex;flex-direction:column;gap:8px}
</style>
</head>
<body>
  <h1>Live Photo → Drawing (Audio reactive)</h1>

  <div id="controls" class="panel">
    <div class="col">
      <label class="small">Image</label>
      <input id="imgFile" type="file" accept="image/*" />
    </div>

    <div class="col">
      <label class="small">Audio (optional)</label>
      <input id="audioFile" type="file" accept="audio/*" />
      <div class="row">
        <button id="playAudio" disabled>Play Audio</button>
        <button id="stopAudio" disabled>Stop</button>
      </div>
    </div>

    <div class="col">
      <label class="small">Drawing Controls</label>
      <div class="row small">
        <button id="start">Start Drawing</button>
        <button id="pause">Pause</button>
        <button id="reset">Reset</button>
        <button id="download">Download PNG</button>
      </div>
    </div>

    <div class="col">
      <label class="small">Threshold <span id="valThreshold">100</span></label>
      <input id="threshold" type="range" min="0" max="255" value="100" />
      <label class="small">Density <span id="valDensity">1.0</span></label>
      <input id="density" type="range" min="0.1" max="3" step="0.1" value="1.0" />
      <label class="small">Stroke width <span id="valStroke">2</span></label>
      <input id="stroke" type="range" min="0.5" max="8" step="0.1" value="2" />
      <label class="small">Speed <span id="valSpeed">1.0</span></label>
      <input id="speed" type="range" min="0.1" max="4" step="0.1" value="1.0" />
      <label class="small">Jitter (sketchiness) <span id="valJitter">1</span></label>
      <input id="jitter" type="range" min="0" max="8" step="0.1" value="1" />
      <label><input id="invert" type="checkbox" /> Invert strokes</label>
    </div>
  </div>

  <canvas id="canvas" width="900" height="600"></canvas>

  <footer class="panel small">
    Tip: load audio to make drawing react to music (louder → faster & thicker). Try different thresholds & density for variety.
  </footer>

<script>
(() => {
  const imgFile = document.getElementById('imgFile');
  const audioFile = document.getElementById('audioFile');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  const off = document.createElement('canvas');
  const offCtx = off.getContext('2d', { alpha: false });

  // controls
  const threshold = document.getElementById('threshold');
  const density = document.getElementById('density');
  const stroke = document.getElementById('stroke');
  const speed = document.getElementById('speed');
  const jitter = document.getElementById('jitter');
  const invert = document.getElementById('invert');

  const valThreshold = document.getElementById('valThreshold');
  const valDensity = document.getElementById('valDensity');
  const valStroke = document.getElementById('valStroke');
  const valSpeed = document.getElementById('valSpeed');
  const valJitter = document.getElementById('valJitter');

  const startBtn = document.getElementById('start');
  const pauseBtn = document.getElementById('pause');
  const resetBtn = document.getElementById('reset');
  const downloadBtn = document.getElementById('download');

  const playAudioBtn = document.getElementById('playAudio');
  const stopAudioBtn = document.getElementById('stopAudio');

  // audio stuff
  let audioCtx = null, audioSource = null, analyser = null, audioBufferSrc = null;
  let audioDataArray = null, audioPlaying = false;
  let audioElement = null;

  // drawing data
  let points = []; // {x,y,intensity}
  let drawIndex = 0;
  let animationId = null;
  let paused = false;

  // update UI values
  function updateUIValues() {
    valThreshold.innerText = threshold.value;
    valDensity.innerText = parseFloat(density.value).toFixed(1);
    valStroke.innerText = parseFloat(stroke.value);
    valSpeed.innerText = parseFloat(speed.value).toFixed(1);
    valJitter.innerText = parseFloat(jitter.value);
  }
  [threshold,density,stroke,speed,jitter].forEach(el => el.addEventListener('input', updateUIValues));
  updateUIValues();

  // Load image
  imgFile.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = () => {
      // size canvas to image (fit max width)
      const maxW = Math.min(window.innerWidth - 40, 1200);
      const scale = Math.min(1, maxW / img.width);
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      off.width = canvas.width;
      off.height = canvas.height;

      offCtx.drawImage(img, 0, 0, off.width, off.height);
      // show original briefly
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(off,0,0);
      // extract edge points
      computePoints();
    };
    img.src = url;
  });

  // Load audio file
  audioFile.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    // use audio element for simple playback so user can stop
    if (audioElement) {
      audioElement.pause();
      audioElement = null;
    }
    const url = URL.createObjectURL(f);
    audioElement = new Audio(url);
    audioElement.crossOrigin = "anonymous";
    playAudioBtn.disabled = false;
    stopAudioBtn.disabled = false;

    // connect to analyser
    if (audioCtx && !analyser) {
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      audioDataArray = new Uint8Array(analyser.frequencyBinCount);
    }
    // create source node from element
    if (audioSource) {
      try { audioSource.disconnect(); } catch {}
      audioSource = null;
    }
    const track = audioCtx.createMediaElementSource(audioElement);
    track.connect(analyser);
    analyser.connect(audioCtx.destination);
    audioSource = track;
  });

  playAudioBtn.addEventListener('click', async () => {
    if (!audioElement) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
   
